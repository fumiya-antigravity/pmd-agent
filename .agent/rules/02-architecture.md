---
description: "Flows/Crews分離のアーキテクチャ定義。パイプライン構造と各Crewの責務。"
alwaysApply: true
---

# 02: アーキテクチャ定義

## 設計原則: Flows/Crews分離

CrewAIの設計思想を適用: **決定論的プロセス制御（Flows）と知的処理（Crews）を分離**。

### Flow層（`src/app.js`）

コードで書かれた予測可能なビジネスロジック。AIの判断に依存しない。

- フェーズ遷移ルール（WELCOME → INITIAL → WHY_SESSION → DEEP_DIVE → ASPECT_CHECK）
- 各Crewの呼び出し順序制御（パイプライン）
- Crew出力のバリデーション（スキーマ準拠チェック）
- 状態管理（aspects, status, history）
- エラーハンドリング（Crew失敗時のフォールバック）

### Crew層（`src/ai/crews/`）

各Crewは1つの明確な責務を持つ独立したAI呼び出し単位。

| Crew | 責務 |
|---|---|
| **オーケストレーター** | 全Crew出力を統合・検証。整合性チェック（最重要） |
| **① 観点分析** | フォーカス中の1観点のstatus/text判定 |
| **② 横展開** | ユーザー発言が他の4観点に与える影響の分析 |
| **③ コンタミ検知** | How/What混入の意味的検知 |
| **④ 検証** | ①②の結果の独立検証（thin時のみ実行） |
| **⑤ メッセージ生成** | ユーザー向けフィードバック生成 |

### パイプライン

```
ユーザー発言
    ├──→ ③ コンタミ検知（並列可）
    ├──→ ① 観点分析
    ├──→ ② 横展開
    ├──→ 🎯 オーケストレーター（全体整合性チェック）
    ├─[thin?]─→ ④ 検証
    └──→ ⑤ メッセージ生成 → UI更新
```

### プロダクトAI設計の場所

プロダクトAI（壁打ちパートナー）の振る舞い定義は `.agent/rules/` ではなく `src/ai/rules/` に配置。
開発AIルール（このファイル群）とプロダクトAI設計は明確に分離する。

## 自動更新ルール

> ⚠️ 追加開発・リファクタリング完了時に、このファイルの更新要否を必ずチェック。
> 新Crew追加、パイプライン変更等があれば反映する。
