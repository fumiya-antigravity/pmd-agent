---
description: "実装品質ルール。L1-L4検証レベル、推測修正回数制限、DB直接クエリ必須。コード変更・バグ修正時は必ず参照。"
alwaysApply: true
---

# 実装品質ルール

## 目的
表面的な実装ではなく、ユーザーが実際に使う場面での正しい動作を保証するためのルール。

## 1. 実装の検証原則

### コードパスの存在 ≠ 正しい動作
- 関数が定義されている、呼び出しコードがある、だけでは「実装済み」と判断してはならない
- 必ず**入力→処理→出力→表示**の完全なデータフローをトレースし、各段階で期待値と一致するか確認する

### 「動いている」のレベルを区別する
| レベル | 説明 | 例 |
|--------|------|-----|
| L1: コード存在 | 関数やコードブロックが存在する | saveMessage()が定義されている |
| L2: 呼び出し | コードが実際に呼ばれている | saveMessage()が適切な箇所で呼ばれている |
| L3: 保存成功 | データが正しく永続化されている | DBテーブルに期待するレコードが存在する |
| L4: 復元成功 | 保存データから元の状態が復元できる | ブラウザ更新後に同じ画面が表示される |

**L4まで確認しない限り「実装完了」と報告してはならない。**

## 2. バグ修正の原則

### 1つ見つけたら同パターンを全探索する
- 1つのバグを見つけた場合、同じパターンのバグが他にもないか必ず全ファイル・全箇所を探索する
- 例: 「保存時にフィールドが欠けている」→ 保存関数の全呼び出し箇所で同じフィールド欠落がないか確認

### 根本原因を特定してから修正する
- 表面的な症状（例: UIの表示が違う）だけを修正するのではなく、**なぜそうなるのか**のデータフローを追跡する
- データの生成→保存→復元→表示の、どの段階で問題が発生しているかを特定してから修正に入る

## 3. テーブル・スキーマ変更時の確認事項

### 新テーブル追加時のチェックリスト
- [ ] テーブルのCREATE SQLを用意したか
- [ ] CRUD関数をクライアントに追加したか
- [ ] 保存呼び出しを適切な箇所に追加したか
- [ ] 復元・読み込み呼び出しを適切な箇所に追加したか
- [ ] ブラウザ更新での復元テストを実施したか

## 4. ユーザー要望への対応原則

### 「土台」と「装飾」の優先順位
データの保存・復元・表示の正確性（土台）が壊れている場合:
- UI改善、新機能追加、プロンプト調整等の「装飾」的な作業は後回しにする
- 土台が壊れた状態で装飾を重ねても、ユーザーの根本的な不満は解消されない

### ユーザーが繰り返し要望している場合の対応
同じ要望が複数回出てきた場合:
- これはお前が過去に「実装済み」と報告したが実際には正しく動いていないことを示す
- 即座に本当に動いているかのE2Eテストを実施する
- 「コードがある」は証拠にならない。実際の動作だけが証拠

## 5. バグ調査の原則【最重要】

> [!CAUTION]
> 過去に推測ベースの修正を5回以上繰り返し、全て的外れだった前例がある（2026-02-16）。

### 推測での修正は最大2回まで
コードリーディングだけで原因を推測して修正するのは**最大2回まで**。
2回失敗したら、必ず以下の「データ駆動調査」に切り替える。

### データ駆動調査（推測より常に優先）
バグ報告を受けたら、コードを読む前に**実データを確認**する:

1. **L3を最初に確認**: DBにデータが存在するか？
   ```bash
   curl -s 'https://{project}.supabase.co/rest/v1/{table}?session_id=eq.{id}' -H 'apikey: {key}'
   ```
2. **パターン分析**: 全セッションのデータを比較し、共通パターンを見つける
3. **原因箇所の特定**: データの有無から「保存側」か「復元側」かを判定
4. **デバッグログをデプロイ**: 推測ではなく実データで確認

### 「動いている」の証拠基準
| 証拠レベル | 内容 | 十分か？ |
|------------|------|--------|
| コードが存在する | 関数が定義されている | ❌ 不十分 |
| コードが呼ばれている | 呼び出し側コードがある | ❌ 不十分 |
| DBにデータがある | REST APIで確認済み | ✅ L3合格 |
| リロードで画面が復元 | ブラウザで目視確認 | ✅ L4合格 |
