# PRD・要件定義 作成ワークフロー

// turbo-all

---

## このワークフローの目的

このプロジェクトにおいて、PRDと要件定義を**全体最適・粒度統一・学術根拠付き**で作成するためのプロセスを定義する。  
部分最適な記述・つながりの不明瞭さ・粒度の不統一が「外部設計でのバトンリレー漏れ」を引き起こすため、このワークフローを必ず遵守する。

---

## PRD・要件定義を作成するステップ

### ステップ 1: 既存コードベースを全体スキャンする

```bash
# ディレクトリ構造を把握する
ls -la src/
ls -la src/ai/
ls -la src/ai/crews/
ls -la src/ai/prompts/
ls -la api/
ls -la supabase/migrations/
```

確認すべき観点:
- 既存の実装ファイルと責務を把握する
- 現在のデータフロー（どのファイルが何を受け渡しているか）
- DB スキーマの現状（migrations ファイル）

---

### ステップ 2: PRD を作成する（学術根拠付き）

PRD は以下の **8セクション構成** で作成する:

```
## 0. エグゼクティブサマリー（ビジョン1文）
## 1. Why（なぜ作るのか）
   1.1 問題の構造
   1.2 解決すべき本質（具体的なフロー例を必ず含める）
   1.3 学術的根拠（各理論の「応用方法」まで記載）
## 2. ビジョンとゴール（KPI・ペルソナ）
## 3. 機能要件
   3.1 ユーザー体験フロー図（mermaid必須）
   3.2 AIロール定義（計算ロジック・学術根拠を含む完全仕様）
   3.3 仮説生成品質基準
## 4. 非機能要件（フェーズ別の応答速度まで記載）
## 5. 既存実装との対照（影響箇所の特定）
## 6. 情報バトンリレーの完全性チェックリスト（フェーズ別）
## 7. 実装フェーズ計画（Role別・ファイル別のタスク）
## 8. 設計思想の核心（変えてはならないこと）
```

---

### ステップ 3: AIロール定義の品質基準

各 AIロールは以下の **5要素** を必ず記載する。1つでも欠けたら不完全とみなす:

```
① 責務（一文で明確に）
② 使用アルゴリズム・学術理論（表形式）
   - アルゴリズム名 | 根拠（著者・年） | このプロダクトでの実装内容
③ 計算定義・判定ロジック（擬似コード形式）
   - 具体的な数値・閾値・変数名を含む
   - 境界条件（< 60% / 60〜79% / ≥ 80% など）を明示
④ 入出力スキーマ（JSON形式）
⑤ NG例・OK例（特に禁止語・推奨語）
```

---

### ステップ 4: 全体整合性チェック（部分最適の排除）

PRD の全文を書き終えたら、**必ず以下の順で通読して整合性を確認する**:

#### 4-1. 粒度チェック
- 最も詳細に書かれたセクションを基準に、他のセクションの粒度が揃っているか
- 「計算式でロジックを定義しているRole A」があるなら、他のRoleも同じ粒度で書く
- 箇条書きで終わっているセクションがあれば、詳細なセクションに合わせる

#### 4-2. つながりチェック
- あるセクションで定義された用語・変数名が、他セクションで同じ名前で使われているか
- フロー図の矢印の先に対応するロール定義があるか
- §3.1 のフロー図と §6 のバトンリレーチェックリストが対応しているか

#### 4-3. 矛盾チェック
- 「会話中にスライダー」と「会話後にスライダー」など、設計が変わった場合は古い記述を全て削除
- 「実装済み」と書いてある機能が、設計変更で「廃止」になっていないか
- KPI の指標が機能要件で測定可能な設計になっているか

#### 4-4. 漏れチェック
- 新しく追加したロール（Role E など）が §4 非機能要件・§5 影響箇所・§7 フェーズ計画にも反映されているか
- フェーズ計画のタスクに、それを実装する具体的なファイル名が書かれているか

---

### ステップ 5: 学術理論の適用基準

PRD で学術理論を引用する際は以下を守る:

| 適用ルール | 内容 |
|-----------|------|
| **応用方法まで書く** | 「Festinger(1954)：閾値で反応様式が変化」→「→ MGU 60%超で質問スタイルを切り替える」 |
| **具体的な数値に紐付ける** | 「ミラーの法則 7±2」→「スライダーは最大5件（7±2の中央値）」 |
| **なぜ使うのかを一行添える** | 理論の説明だけでなく「このシステムでどう機能するか」を必ず書く |
| **既存理論と矛盾しないか確認** | 複数の理論が同一の設計に適用される場合、矛盾がないか確認 |

---

### ステップ 6: 設計変更時の更新ルール

設計変更が発生した場合（例: スライダーの役割を変えた）、以下を **全て同時に更新** する:

1. §3.1 体験フロー図（mermaid）
2. §3.1 バトンリレーの全フロー
3. §3.2 対象Roleの定義
4. §4 非機能要件（応答速度等）
5. §5 既存実装との対照表（廃止・新規の明記）
6. §6 情報バトンリレーチェックリスト（フェーズ別）
7. §7 実装フェーズ計画（タスク追加・削除）

**1つでも更新が漏れた場合、外部設計でのバトンリレーに支障をきたす。**

---

### ステップ 6.5: PRD更新時の全体最適ルール（最重要）

PRDに新しい知見・ルール・設計変更を反映する場合、**「足すだけ」は絶対禁止**。  
必ず以下のプロセスで**全体最適**を行う:

#### なぜ全体最適が必要か

```
NG（部分最適）:
  新しい学びがあった
  → PRDの末尾に追記
  → 既存セクションと重複・矛盾が発生
  → PRDの信頼性が低下
  → 読んでも正しい行動がとれない

OK（全体最適）:
  新しい学びがあった
  → PRDの全セクションを通読
  → 既存の記述と統合・再構成
  → 1つの概念は1つの場所にのみ存在
  → PRDが常に単一の真実の源泉であり続ける
```

#### 全体最適の具体的プロセス

```
1. 影響範囲の特定
   - 追加する知見が、既存のどのセクションに関連するかを全て洗い出す
   - 例: 「How禁止」は §3.2(Role A), §3.2(Role B), §3.3, §6, §8 に関連

2. 既存記述の確認
   - 関連セクションを全て読み、追加内容と重複・矛盾がないかチェック
   - 既に似た記述があれば「追記」ではなく「書き換え・統合」する

3. 再構成
   - 新しい知見を、最も適切なセクションに「溶け込ませる」
   - 箇条書きの1行追加ではなく、そのセクション全体を再読して自然な文脈で組み込む
   - 1つの概念が複数箇所に分散しないようにする（DRY原則）

4. 影響波及の確認
   - ステップ6の更新対象リスト（§3.1〜§7）を全てチェック
   - 用語の統一（ステップ7）に違反していないか確認

5. 通読確認
   - PRD全文を上から下まで通読し、追記した箇所が「前から書いてあったかのように」
     自然に溶け込んでいるか確認
```

#### 具体例

```
NG: 「認知フィルタにHow禁止を追加」→ §3.2に1行追記 → §8に言及なし
    → 読み手は§8を読んでもHow禁止を知らない → 設計思想として共有されない

OK: 「認知フィルタにHow禁止を追加」
    → §3.2 Role Aの認知フィルタセクションを丸ごと書き直し
    → §3.2 Role Bの共通制約にも反映
    → §8の設計思想に第1原則として追加
    → §6のバトンリレーにも反映
    → 全体を通読して矛盾なしを確認
```

---

### ステップ 7: 用語の統一ルール

このプロジェクトで以下の用語は固定とする。PRD内で別の表現を使わない:

| 正式名称 | 禁止する表記 |
|---------|------------|
| `main_goal_understanding` (MGU) | 「大元の理解度」（コードでは省略可） |
| `sub_question_clarity` (SQC) | 「派生質問の解像度」 |
| `confirmed_insights` | 「確認済みインサイト」「肯定した仮説」（コメントでは可） |
| `anchor` | 「元メッセージ」「最初の問い」（コメントでは可） |
| `question_type: "open"` | 「オープン型」（コメントでは可） |
| `question_type: "hypothesis"` | 「仮説提示型」（コメントでは可） |
| Role A / B / C / D / E | 「Planner / Interviewer / Synthesizer / Reporter / Manager」（コメントでは可） |

---

## チェックリスト（PRD提出前に必ず確認）

- [ ] 全Roleに①〜⑤の5要素が揃っているか
- [ ] mermaid フロー図と §6 バトンリレーが対応しているか
- [ ] 最細粒度 = 最粗粒度か（粒度が揃っているか）
- [ ] 設計変更箇所が全セクションに反映されているか
- [ ] 各学術理論に「応用方法」が書かれているか
- [ ] §5 実装対照表に廃止項目と新規実装が明記されているか
- [ ] §7 フェーズ計画の全タスクに具体的なファイル名があるか
- [ ] **【更新時】追記ではなく全体最適して再構成したか（ステップ6.5）**
- [ ] **【更新時】追記した箇所が「前から書いてあったかのように」自然に溶け込んでいるか**
