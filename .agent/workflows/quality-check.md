---
description: コード変更後の品質検証ワークフロー。全ての実装・修正で必須。
---

// turbo-all

# 品質検証ワークフロー

全てのコード変更（新機能、バグ修正、リファクタリング）後に必ず実施する。
**AIも人間もこのワークフローを省略してはならない。**

## Step 1: 変更の影響範囲を特定する

変更したコードの影響範囲を明確化する:
- **直接影響**: 変更した関数・コンポーネントの呼び出し元/呼び出し先
- **間接影響**: 変更による状態変更を参照する他のコード
- **データフロー影響**: 変更がデータの生成→保存→復元→表示のどこに関わるか

## Step 2: 関心の分離を確認する

変更したコードが以下の原則を守っているか確認:
- UI表示ロジックとデータ永続化ロジックが**別のコードブロック**にあるか?
- DB保存がUI条件分岐（`if (result.message)` 等）の中に入っていないか?
- 変数は使用箇所より前に宣言・代入されているか?

もし違反があれば、**修正してからStep 3に進む**。

## Step 3: 保存→復元の完全性を確認する（データ永続化が関わる場合）

変更がデータ保存に関わる場合、以下を確認:

1. **保存コードの確認**: `dbSync.save*` が呼ばれるパスに到達するか？条件分岐でスキップされないか？
2. **DB実データ確認**: Supabase REST APIで実際にDBにデータが保存されたか確認:
```bash
curl -s 'https://mfwgpicsalflypomhuly.supabase.co/rest/v1/{table}?session_id=eq.{id}&select=*&limit=5' \
  -H 'apikey: {anon_key}' | python3 -m json.tool
```
3. **復元確認**: ブラウザをCmd+Shift+Rでリロードし、保存前と同じ画面が表示されるか確認

## Step 4: エラーハンドリングを確認する

- try-catchブロック内で**エラーが握りつぶされていないか**?
- catch内で適切なログ出力がされているか?
- ユーザーにエラーが表示される場合、**メッセージが理解可能か**?

## Step 5: デプロイ後に動作確認する

1. キャッシュバスターを更新する（`public/index.html`のスクリプトタグの`?v=`パラメータ）
2. コミット＆プッシュする
3. Vercelデプロイ完了後、デプロイ環境で実際に操作して動作確認する
4. ブラウザのコンソールにエラーが出ていないか確認する

## Step 6: ユーザーに結果を報告する

報告時は以下を含める:
- **何を変更したか**: 変更内容の簡潔な説明
- **何で確認したか**: DB直接クエリ結果、ブラウザスクリーンショット、コンソールログ等の**実データに基づく証拠**
- **何が動いているか**: 「コードが存在する」ではなく「実際に動作した」証拠

> コードリーディングだけの確認は証拠として不十分。
> 実データ（DB、コンソールログ、画面）に基づく確認のみ有効。
