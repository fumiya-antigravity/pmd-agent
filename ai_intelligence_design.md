# AI コア知能設計書

> 壁打ちパートナーAIの知能アーキテクチャ仕様

---

## 1. プロンプト階層構造

```
Layer 1: CORE_RULES（常時送信 ~500トークン）
├── 根本思想: 情報伝達の50%問題
├── 絶対ルール: 6項目
├── 5観点定義 + 判定視点
└── トーン規定

Layer 2: PHASES（フェーズ別送信）
├── INITIAL_ANALYSIS: 文脈推論 → 5観点抽出
├── WHY_SESSION: 壁打ち対話（人格+反論分析+関連度スコア）
├── DEEP_DIVE: ソクラテス式深掘り
├── ASPECT_CHECK: 網羅性診断
└── VERIFY_ANALYSIS: 多段階検証

Layer 3: buildContext（動的コンテキスト）
├── 全観点のstatus + text要約
├── フォーカス観点: 全文 + reason + advice
└── AIステータスの明示
```

---

## 2. 文脈推論ステップ（INITIAL_ANALYSIS）

判定前に必ず実行する3ステップ:
1. ユーザー入力全体の俯瞰 → 「実現したいことの本質」
2. 暗黙情報の推論 → 文脈から読み取れる未記述の情報
3. 観点横断の関連整理 → 複数観点にまたがる情報の発見

### 文脈的判定
- 形式的な文字数だけでなく、文脈的に十分かどうかで判定
- 他の観点に書かれた情報も横断的に活用

---

## 3. 5観点と判定視点

| 観点 | 判定視点 |
|---|---|
| background | 「現状どうやっているか」「何がトリガーか」|
| problem | 「誰が」「何に」困っているか。部分欠損は補う質問。定量化は後でよい |
| target | 文脈的に自明なら認める。形式属性より「どんな状況の人か」|
| impact | 定性的変化でもOK。定量化は自然に深まればよい |
| urgency | 「今やらないと何が起きるか」or「今だからこそやれる理由」|

---

## 4. 対話品質の維持（WHY_SESSION）

### 人格の一貫性
- 初回分析と同じ知能レベルで対話を継続
- 固定テンプレ的応答は禁止。毎回異なる角度から掘り下げ

### 反論・指摘への対応
1. 会話履歴から該当するAI発言を特定（直前+数ターン前）
2. AI発言とユーザー指摘を比較分析
3. ユーザーの指摘が正当か自律的に判断（鵜呑みにしない）
4. ユーザーの裏にある本質を推論
5. 芯を食ったフィードバック

---

## 5. 多段階AI呼び出し

```
User Message → Step 1(通常分析) → [thin判定?] → Step 2(検証) → マージ → 応答
                                    └── [ok/empty] → そのまま応答
```

### 安全装置
- **MAX_VERIFY_CALLS = 1**: 検証は最大1回（無限ループ防止）
- Step 2はthin判定時のみ発火（全リクエストの30-50%）
- Step 2失敗時はStep 1の結果をそのまま使用

---

## 6. 関連観点の連動更新

### 関連度スコア（0.0〜1.0）

| スコア | アクション |
|---|---|
| 0.0-0.3 | 更新しない |
| 0.4-0.6 | 記録のみ（次回判定材料） |
| 0.7-1.0 | 矛盾チェック後に更新 |

### 更新アクション
- **append**: 既存textに追記
- **overwrite**: text全体を置換（大きく変わる場合）
- **skip**: 更新しない

### 矛盾防止
- 矛盾検出時 → 更新せず、ユーザーに確認メッセージ
- text更新後 → statusも必ず再整合

---

## 7. buildContext 送信情報

| 対象 | 送信内容 |
|---|---|
| フォーカス中の観点 | status + text全文 + reason + advice |
| その他の観点 | status + text先頭80文字 |

会話履歴: 最新10件を送信（文脈理解の深度確保）
